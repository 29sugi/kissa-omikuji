<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å–«èŒ¶åº— æ˜Ÿåº§ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŠã¿ãã˜</title>

<style>
body{
  font-family:"Noto Serif JP",serif;
  background:#f6f1e7;
  margin:0;
  text-align:center;
  color:#2a2a2a;
}
.wrap{max-width:860px;margin:0 auto;padding:18px;}
h1{font-size:22px;margin:10px 0 14px;}

.machine{
  background:#fff7ea;
  border:2px solid #6b4f3a;
  border-radius:16px;
  padding:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}

/* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
.dial-wrap{
  position:relative;
  width:340px;height:340px;
  margin:10px auto 8px;
}

/* å¤–å‘¨48åˆ†å‰²ãƒªãƒ³ã‚° */
.ring{
  position:absolute; inset:0;
  border-radius:50%;
  border:8px solid #6b4f3a;
  transform:rotate(0deg);
  transition:transform 3s cubic-bezier(.1,.9,.1,1);
  background:
    repeating-conic-gradient(
      rgba(40,40,40,.62) 0 1deg,
      transparent 1deg 7.5deg
    ),
    conic-gradient(#f5f6f8,#cfd5dd,#f7f8fa,#bfc6cf,#f5f6f8);
}
.ring::after{
  content:"";
  position:absolute;
  inset:60px;
  border-radius:50%;
  background:#fff7ea;
  box-shadow:inset 0 0 0 2px rgba(0,0,0,.1);
}

/* ä¸­å¤® */
.center{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:220px; height:220px;
  border-radius:50%;
  background:#fff;
  border:2px solid rgba(107,79,58,.5);
  box-shadow:0 10px 24px rgba(0,0,0,.15);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:3;
}
.zicon{font-size:90px;color:#6b4f3a;}
.zname{
  position:absolute;
  bottom:25px;
  font-size:13px;
  opacity:.7;
}

/* ä¸‹å´ã®é‡‘ä¸‰è§’ */
.pointer{
  position:absolute;
  left:50%;
  bottom:-8px;
  transform:translateX(-50%) rotate(180deg);
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-top:32px solid #d4af37;
  filter:drop-shadow(0 3px 4px rgba(0,0,0,.35));
  z-index:5;
}

/* UI */
.panel{margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center;}
select,button{
  padding:10px 12px;
  border-radius:12px;
  border:2px solid #6b4f3a;
  background:#fff;
  font-size:15px;
}
button{cursor:pointer}
button:disabled{opacity:.5; cursor:not-allowed}
.status{margin-top:10px;font-size:14px;opacity:.9}

/* slotï¼ˆå‡ºå£ãƒ©ãƒ™ãƒ«ã¯æ¶ˆã™ï¼‰ */
.slot{
  width:min(520px, 96%);
  margin:14px auto 0;
  padding:12px;
  background:#fff;
  border-radius:14px;
  border:2px solid #6b4f3a;
  box-shadow: inset 0 10px 18px rgba(0,0,0,.06);
}
.slot-top{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  font-size:13px;
  opacity:.75;
  margin-bottom:10px;
}
.mouth{
  position:relative;
  height:44px;
  border-radius:12px;
  background:linear-gradient(#2a211a, #1e1712);
  box-shadow: inset 0 8px 18px rgba(0,0,0,.55);
  overflow:hidden;
}
.mouth::before{
  content:"";
  position:absolute; left:10px; right:10px; top:10px; height:10px;
  border-radius:10px;
  background:rgba(255,255,255,.08);
}
.mouth::after{
  content:"";
  position:absolute; left:0; right:0; bottom:0; height:10px;
  background:rgba(0,0,0,.25);
}

/* ç´™ãŒå‡ºã¦ãã‚‹æ¼”å‡º */
.paper{
  position:relative;
  width:min(520px, 85%);
  margin:0 auto;
  transform:translateY(-6px);
  pointer-events:none;
}
.ticket{
  width:100%;
  background:#fff;
  border:1px solid #ddd;
  border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.16);
  padding:14px 14px 12px;
  text-align:left;
  transform:translateY(-120%);
  opacity:0;
}
.ticket.show{
  animation: outPaper 700ms cubic-bezier(.1,.9,.2,1) forwards;
}
@keyframes outPaper{
  0%{ transform:translateY(-120%); opacity:0; }
  55%{ transform:translateY(-8%); opacity:1; }
  70%{ transform:translateY(-14%); }
  100%{ transform:translateY(0%); opacity:1; }
}
.ticket h2{margin:0 0 8px;font-size:18px;}
.meta{font-size:12px;opacity:.75;margin:0 0 10px;}

/* â˜…ç¸¦1åˆ—ã®çµæœè¡¨ç¤º */
.list{
  font-size:14px;
}
.line{
  margin:6px 0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.gap{height:10px;}
.small{
  font-size:13px;
  opacity:.85;
  white-space:normal; /* ä¸€è¨€ãƒ»æ³¨æ„ã¯æŠ˜è¿”ã—OK */
}

/* éŸ³ON/OFFãƒœã‚¿ãƒ³ */
.sound-btn{
  padding:10px 12px;
  border-radius:12px;
  border:2px solid #6b4f3a;
  background:#fff;
  font-size:15px;
}
.sound-btn.off{
  opacity:.65;
}
</style>
</head>

<body>
<div class="wrap">
<h1>å–«èŒ¶åº— æ˜Ÿåº§ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŠã¿ãã˜</h1>

<div class="machine">
  <div class="dial-wrap">
    <div id="ring" class="ring"></div>
    <div class="pointer"></div>

    <div class="center">
      <div class="zicon" id="zicon">âœ¦</div>
      <div class="zname" id="zname">æ˜Ÿåº§ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    </div>
  </div>

  <div class="panel">
    <select id="zodiac">
      <option value="">é¸ã‚“ã§ãã ã•ã„</option>
      <option value="0">ç‰¡ç¾Šåº§</option><option value="1">ç‰¡ç‰›åº§</option><option value="2">åŒå­åº§</option><option value="3">èŸ¹åº§</option>
      <option value="4">ç…å­åº§</option><option value="5">ä¹™å¥³åº§</option><option value="6">å¤©ç§¤åº§</option><option value="7">è åº§</option>
      <option value="8">å°„æ‰‹åº§</option><option value="9">å±±ç¾Šåº§</option><option value="10">æ°´ç“¶åº§</option><option value="11">é­šåº§</option>
    </select>

    <button id="lever" disabled>ãƒ¬ãƒãƒ¼ã‚’å¼•ã</button>
    <button id="reset" disabled>ã‚‚ã†ä¸€å›</button>
    <button id="soundBtn" class="sound-btn" type="button">ğŸ”Š éŸ³ON</button>
  </div>

  <div class="status" id="status">æ‰‹é †ï¼šæ˜Ÿåº§ â†’ ãƒ¬ãƒãƒ¼</div>

  <div class="slot">
    <div class="slot-top">
      <div id="hint">å›è»¢ãŒæ­¢ã¾ã‚‹ã¾ã§å¾…ã£ã¦ã­</div>
    </div>

    <div class="mouth"></div>

    <div class="paper">
      <div id="ticket" class="ticket" aria-live="polite">
        <h2 id="luck">â€”</h2>
        <div class="meta" id="meta">â€”</div>

        <!-- â˜…ç¸¦1åˆ— -->
        <div class="list">
          <div class="line" id="today"></div>

          <div class="line" id="love"></div>
          <div class="line" id="work"></div>
          <div class="line" id="health"></div>
          <div class="line" id="money"></div>
          <div class="line" id="people"></div>
          <div class="line" id="time"></div>

          <div class="gap"></div>

          <div class="line" id="item"></div>
          <div class="line" id="food"></div>
          <div class="line" id="color"></div>

          <div class="gap"></div>

          <div class="line small" id="one"></div>
          <div class="line small" id="caution"></div>
        </div>

        <div class="footer-note small" style="margin-top:10px; opacity:.7;">
          â€»å–«èŒ¶åº—ã®é›°å›²æ°—ã ã‘ã§ã™ï¼ˆå®Ÿéš›ã®é‹å‹¢ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
const ring = document.getElementById("ring");
const zodiacSel = document.getElementById("zodiac");
const leverBtn = document.getElementById("lever");
const resetBtn = document.getElementById("reset");
const zicon = document.getElementById("zicon");
const zname = document.getElementById("zname");
const statusEl = document.getElementById("status");
const ticket = document.getElementById("ticket");
const hint = document.getElementById("hint");
const soundBtn = document.getElementById("soundBtn");

const zodiacs = ["ç‰¡ç¾Šåº§","ç‰¡ç‰›åº§","åŒå­åº§","èŸ¹åº§","ç…å­åº§","ä¹™å¥³åº§","å¤©ç§¤åº§","è åº§","å°„æ‰‹åº§","å±±ç¾Šåº§","æ°´ç“¶åº§","é­šåº§"];
const icons = ["â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“"];

/* ãŠã¿ãã˜æ–‡è¨€ */
const lucks = [
  {name:"å¤§å‰", weight:6},
  {name:"ä¸­å‰", weight:10},
  {name:"å°å‰", weight:14},
  {name:"å‰", weight:18},
  {name:"æœ«å‰", weight:16},
  {name:"å‡¶", weight:10},
  {name:"å¤§å‡¶", weight:4}
];

const love = ["è¨€è‘‰ã‚’çŸ­ãã€ä¸å¯§ã«ã€‚","è¿”äº‹ã¯æ€¥ãŒãšã€æ¸©åº¦ã‚’åˆã‚ã›ã‚ˆã€‚","è¿‘é“ã‚ˆã‚Šæ­£é¢çªç ´ã€‚","ä»Šæ—¥ã¯èãå½¹ãŒå‰ã€‚","å¶ç„¶ã®å†ä¼šã«æ³¨æ„ã€‚"];
const work = ["æ®µå–ã‚ŠãŒå‹ã¡ã€‚","1ã¤ã ã‘ç‰‡ã¥ã‘ã‚‹ã¨æµã‚ŒãŒå‡ºã‚‹ã€‚","ç¢ºèªã¯ä¸€å›å¤šã‚ã«ã€‚","ç„¦ã‚Šã¯æ‰‹é †ã‚’æº¶ã‹ã™ã€‚","ãƒ¡ãƒ¢ãŒã‚ãªãŸã‚’æ•‘ã†ã€‚"];
const health = ["é¦–ã¨è¶³é¦–ã‚’æ¸©ã‚ã‚ˆã€‚","æ°´ã‚’ä¸€æ¯è¶³ã›ã€‚","çœ æ°—ã¯å‘³æ–¹ã€ç„¡ç†ã¯æ•µã€‚","ç”»é¢ã‹ã‚‰ç›®ã‚’é›¢ã›ã€‚","æ¹¯èˆ¹ãŒæ­£ç¾©ã€‚"];
const money = ["å°ã•ãªå‡ºè²»ã«æ³¨æ„ã€‚","è²¡å¸ƒã®æ•´ç†ã§é‹æ°—ãŒæ•´ã†ã€‚","è²·ã†å‰ã«ä¸€æ™©å¯ã‹ã›ã‚‹ã€‚","â€œå¿…è¦â€ã¨â€œæ¬²ã—ã„â€ã‚’åˆ†ã‘ã‚‹ã€‚","ä»Šæ—¥ã¯ç¯€ç´„ã‚ˆã‚Šæ•´å‚™ã€‚"];
const people = ["è¤’ã‚è¨€è‘‰ã¯å…·ä½“çš„ã«ã€‚","é ¼ã‚€ã‚ˆã‚Šç›¸è«‡ãŒå‰ã€‚","è·é›¢æ„Ÿã¯å°‘ã—åºƒã‚ã€‚","ç›¸æ§Œã§å ´ãŒå›ã‚‹ã€‚","è¨€ã„åˆ‡ã‚‰ãšä½™ç™½ã‚’æ®‹ã›ã€‚"];
const timeLuck = ["åˆå‰","æ˜¼","å¤•æ–¹","å¤œ","æ·±å¤œ"];
const items = ["ç´™ãƒŠãƒ—ã‚­ãƒ³","å¤ã„éµ","ãƒ¡ãƒ¢å¸³","è§’ç ‚ç³–","ãƒãƒƒãƒç®±","ä¸‡å¹´ç­†","å°ã•ãªã‚¿ã‚ªãƒ«","ã—ãŠã‚Š"];
const foods = ["ãƒ—ãƒªãƒ³","ãƒŠãƒãƒªã‚¿ãƒ³","ãƒˆãƒ¼ã‚¹ãƒˆ","ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼","ã‚¯ãƒªãƒ¼ãƒ ã‚½ãƒ¼ãƒ€","ã‚«ãƒ¬ãƒ¼","ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­","ãƒ–ãƒ©ãƒƒã‚¯ã‚³ãƒ¼ãƒ’ãƒ¼"];
const colors = ["é‡‘","æ·±ç·‘","ç¾¤é’","ãˆã‚“ã˜","ç”Ÿæˆã‚Š","éŠ€","èŒ¶","é»’"];

const oneLiners = [
  "ç„¦ã‚‰ãªã„ã€‚é›‘ã«ã‚„ã‚‰ãªã„ã€‚ã“ã‚Œã ã‘ã§å‹ã¡ã€‚","å¯„ã‚Šé“ã«ç¦ã‚ã‚Šã€‚","ä»Šæ—¥ã¯å®ˆã‚ŠãŒæ”»ã‚ã€‚","æ±ºã‚ãªã„æ±ºæ–­ãŒæ­£è§£ã®æ™‚ã‚‚ã‚ã‚‹ã€‚","å°ã•ãæ•´ãˆã‚‹ã¨å¤§ããé€²ã‚€ã€‚"
];
const cautions = [
  "å£æ•°ãŒå¢—ãˆã‚‹ã»ã©å¤±ç‚¹ã—ã‚„ã™ã„ã€‚","äºˆå®šã‚’è©°ã‚ã™ããªã„ã€‚","ç”˜ã„ã‚‚ã®ã§å¸³å°»åˆã‚ã›ã—ãªã„ã€‚","çµè«–ã‚’æ€¥ã„ã§é›‘ã«ã—ãªã„ã€‚","å‹¢ã„ã§è²·ã‚ãªã„ã€‚"
];

function nowStr(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function weightedPick(list){
  const total = list.reduce((s,x)=>s+x.weight,0);
  let r = Math.random()*total;
  for(const x of list){
    r -= x.weight;
    if(r <= 0) return x.name;
  }
  return list[list.length-1].name;
}

/* ===== éŸ³ï¼šç¢ºå®Ÿã«é³´ã‚‹ç‰ˆ + ON/OFF ===== */
let audioCtx = null;
let soundEnabled = true;

function loadSoundPref(){
  const v = localStorage.getItem("omikuji_sound");
  if(v === "off") soundEnabled = false;
  updateSoundBtn();
}
function updateSoundBtn(){
  if(soundEnabled){
    soundBtn.textContent = "ğŸ”Š éŸ³ON";
    soundBtn.classList.remove("off");
  }else{
    soundBtn.textContent = "ğŸ”‡ éŸ³OFF";
    soundBtn.classList.add("off");
  }
}
soundBtn.onclick = async () => {
  soundEnabled = !soundEnabled;
  localStorage.setItem("omikuji_sound", soundEnabled ? "on" : "off");
  updateSoundBtn();
  // ONã«ã—ãŸç›´å¾Œã¯ AudioContext ã‚’èµ·ã“ã—ã¦ãŠãï¼ˆã‚¹ãƒãƒ›å¯¾ç­–ï¼‰
  if(soundEnabled){
    await ensureAudio();
  }
};

async function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended"){
    try { await audioCtx.resume(); } catch(e){}
  }
}

function clickTick(time, gainVal=0.030, freq=1400){
  if(!soundEnabled || !audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "square";
  o.frequency.setValueAtTime(freq, time);

  g.gain.setValueAtTime(0.0001, time);
  g.gain.exponentialRampToValueAtTime(gainVal, time + 0.002);
  g.gain.exponentialRampToValueAtTime(0.0001, time + 0.030);

  o.connect(g); g.connect(audioCtx.destination);
  o.start(time); o.stop(time + 0.04);
}

async function playRatchet(durationMs=3000){
  if(!soundEnabled) return;
  await ensureAudio();

  const start = audioCtx.currentTime + 0.02;
  const dur = durationMs/1000;

  // æ¸›é€Ÿæ„Ÿï¼ˆé€Ÿã„â†’é…ã„ï¼‰
  const steps = 54;
  for(let i=0;i<steps;i++){
    const t = i/(steps-1);
    const when = start + t*dur;
    const gain = 0.040*(1-t) + 0.016; // ã ã‚“ã ã‚“å°ã•ã
    const freq = 1500 - t*450;        // ã ã‚“ã ã‚“ä½ã
    clickTick(when, gain, freq);
  }
  // æœ€å¾Œã®ã€Œã‚³ãƒˆãƒ³ã€
  clickTick(start + dur + 0.03, 0.060, 900);
}
/* ===== /éŸ³ ===== */

let spinning=false;
let ringAngle=0;

function resetPaper(){
  ticket.classList.remove("show");
  void ticket.offsetWidth;
}
function showPaper(){
  resetPaper();
  ticket.classList.add("show");
}

zodiacSel.onchange=()=>{
  if(zodiacSel.value===""){
    leverBtn.disabled=true;
    zicon.textContent="âœ¦";
    zname.textContent="æ˜Ÿåº§ã‚’é¸ã‚“ã§ãã ã•ã„";
  }else{
    const i=Number(zodiacSel.value);
    zicon.textContent=icons[i];
    zname.textContent=zodiacs[i];
    leverBtn.disabled=false;
  }
};

leverBtn.onclick = async () => {
  if(spinning || zodiacSel.value==="") return;

  // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¿…ãšèµ·ã“ã™ï¼ˆã‚¹ãƒãƒ›ã§é‡è¦ï¼‰
  await ensureAudio();

  spinning=true;
  leverBtn.disabled=true;
  zodiacSel.disabled=true;
  resetBtn.disabled=true;

  statusEl.textContent="ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ä¸­â€¦";
  hint.textContent="ã‚«ãƒã‚«ãƒâ€¦æ­¢ã¾ã‚‹ã¾ã§å¾…ã£ã¦ã­";

  resetPaper();
  ticket.style.opacity = 0;

  const chosenIdx=Number(zodiacSel.value);

  // 48ãƒã‚±ãƒƒãƒˆï¼ˆæ˜Ÿåº§12Ã—4ï¼‰
  const pocket=chosenIdx*4+Math.floor(Math.random()*4);
  const pocketCenter=pocket*(360/48)+(360/96);

  const turns=12+Math.floor(Math.random()*6);
  ringAngle=ringAngle+turns*360-pocketCenter;
  ring.style.transform=`rotate(${ringAngle}deg)`;

  // â˜…éŸ³
  playRatchet(3000);

  setTimeout(()=>{
    const luck = weightedPick(lucks);

    document.getElementById("luck").textContent = luck;
    document.getElementById("meta").textContent = `ç™ºè¡Œï¼šå–«èŒ¶ãƒ†ãƒ¼ãƒ–ãƒ«ç¥ç¤¾ / ${nowStr()}`;

    // â˜…æ˜Ÿåº§ã¯çµæœã«å‡ºã•ãªã„ï¼ˆtodayã®ã¿ã«ï¼‰
    document.getElementById("today").textContent = `æ™‚åˆ»ï¼š${pick(timeLuck)}ãŒå‹•ã`;

    document.getElementById("love").textContent = `æ‹æ„›ï¼š${pick(love)}`;
    document.getElementById("work").textContent = `ä»•äº‹ï¼š${pick(work)}`;
    document.getElementById("health").textContent = `å¥åº·ï¼š${pick(health)}`;
    document.getElementById("money").textContent = `é‡‘é‹ï¼š${pick(money)}`;
    document.getElementById("people").textContent = `å¯¾äººï¼š${pick(people)}`;
    document.getElementById("time").textContent = `å‹è² ï¼š${pick(timeLuck)}`;

    // â˜…ãƒ©ãƒ™ãƒ«çŸ­ç¸®
    document.getElementById("item").textContent = `æŒã¡ç‰©ï¼š${pick(items)}`;
    document.getElementById("food").textContent = `é£Ÿï¼š${pick(foods)}`;
    document.getElementById("color").textContent = `è‰²ï¼š${pick(colors)}`;

    document.getElementById("one").textContent = `ä¸€è¨€ï¼š${pick(oneLiners)}`;
    document.getElementById("caution").textContent = `æ³¨æ„ï¼š${pick(cautions)}`;

    ticket.style.opacity = 1;
    showPaper();

    resetBtn.disabled=false;
    spinning=false;
    statusEl.textContent="æ­¢ã¾ã‚Šã¾ã—ãŸã€‚";
    hint.textContent="ã‚‚ã†ä¸€å›ã‚‚ã§ãã¾ã™";
  },3000);
};

resetBtn.onclick=()=>{
  zodiacSel.disabled=false;
  zodiacSel.value="";
  leverBtn.disabled=true;
  resetBtn.disabled=true;
  zicon.textContent="âœ¦";
  zname.textContent="æ˜Ÿåº§ã‚’é¸ã‚“ã§ãã ã•ã„";
  statusEl.textContent="æ‰‹é †ï¼šæ˜Ÿåº§ â†’ ãƒ¬ãƒãƒ¼";
  hint.textContent="å›è»¢ãŒæ­¢ã¾ã‚‹ã¾ã§å¾…ã£ã¦ã­";
  resetPaper();
};

// åˆæœŸåŒ–
loadSoundPref();
</script>
</body>
</html>
